###	Проект для тестирования с системой меню и управлением с помощью энкодера

- **Микроконтроллер:** ATmega328P 
- **Fuse bits:** LOW 0xCE, HIGH 0xD2
- **IDE:** Microchip Studio (Atmel Studio) 7
- **Язык:** C (Embedded)
- **Дисплей:** LCD ST7735 0.96" 80_160(IPS) или 1.8" 128_160(STN)
- **Датчики:** BME280, MPU6050
- **Управление:** Энкодер + кнопка
- **Программатор:** USBasp

###	Больше по дисплею
- можно любой на ST7735, но в дефайнах изменить разрешение, а также параметры LCD_HEIGHT_OFFSET и LCD_WIDTH_OFFSET выставить на 0, либо подобрать свои смещения
- возможно придется поиграться с регистрами MADCTL и INVON/INVOFF дисплея для установки верной ориентации и режима отображения цветов

###	Клонирование репозитория
git clone https://github.com/paschendale1917/avr_test.git

###	Сделано:
- организована обработка энкодера и кнопки на канале А таймера0
- реализовано короткое нажатие и длительное нажатие на кнопку
- организован ШИМ на таймере1(управление подсветкой дисплея)
- реализована автоматическая запись настроек подсветки во встроенную eeprom(требуется установить FUSE бит EESAVE,чтобы eeprom не терлась при стирании памяти контроллера во время прошивки)
- реализован опрос любого свободного входа АЦП, используя  вкачестве триггера прерывания CTC канала А таймера0
- реализованы прием и передача данных по интерфейсам uart, spi, i2c
- написана примитивная библиотека c поддержкой дисплеев двух разрешений(настраивается в дефайнах)
- написана заготовка для меню
- организована навигация по меню
- прием и обработка сырых данных BME280(получение температуры, давления, влажности)
- прием сырых данных с mpu6050(требуется доработка)
- добавлен скринсейвер с отображением лого МФТИ
 
###	Управление:
- вход в меню из скринсейвера по длительному нажатию на энкодер
- выход из меню на скрисейвер по длительному нажатию на энкодер
- вход в дочернее меню (child) по короткому нажатию на кнопку энкодера
- вход в родительское меню (parent) по длительному нажатию на кнопку энкодера
- вход в обработчик пункта меню по короткому нажатию на кнопку энкодера
- выход из обработчика пункта меню по длительному нажатию на кнопку энкодера

###	Краткое описание:
- Создана структура, в которой описаны связи пунктов меню(двунаправленные связные списки)между друг другом и обработчиками состояния меню(попытка в КА).
- В бесконечном цикле мониторится состояние переменной menustate(состояние меню),состояние флагов органов управления, отслеживаются изменения в состоянии меню,которое перерисовывается в соответствии с этими изменениями. Также здесь работает функция display_pointer(pointer), которая меняет положение указателя в соответствии с активным пунктом меню(всегда указывает на него). Координаты указателя явно заданы в структуре. Всё это происходит до того момента, пока переменная menustate не примет значение, соответствующее номеру одного из обработчиков.
- Как только зафиксировано изменение в состоянии органов управления(нажатие кнопки или вращение вала энкодера), то происходит действие в соответствии с заданным функционалом в process_menu() и связями, установленными в структуре пункта меню- это либо вход в обработчик, либо в дочернее меню(кнопка), либо перемещение по меню(вал).
- При входе в обработчик в переменную menustate записывается его номер и таким образом process_menu() передает ему управление. Далее программа действует в соответствии с внутренней логикой обработчика.
- При выходе из обработчика в переменную menustate записывается значение, не соответствующее ни одному из номеров обработчиков, что возвращает управление функции process_menu().
- При старте в переменной menustate записан 0, что соответствует обработчику скринсейвера.
 
###	Внимание!
- Требуется установить галочки и добавить библиотеку как показано на приложенных скриншотах, иначе sprintf не будет корректно работать с float
- При прошивке возможны проблемы, если не отключить дисплей от питания(мега шьется через spi, на котором "сидит" дисплей)

###	Проблемы:
- Меню оказалось весьма затратным излишеством в плане потребления RAM, в некоторый момент, близкий к полному исчерпанию оперативки, начались проблемы с "испорченной" памятью, когда в любой момент начинают "портиться" жестко заданные координаты указателя.

###	TO DO:
- оптимизация меню
- MPU6050 
- разобраться с собакой
- разобраться с режимами низкого энергопотребления
